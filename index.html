---
layout: default
---

  <div data-alert id="didyoumean" class="row hide">
  </div>

  <div class="row results-row">
    <div class="large-4 columns">
      <div class="panel radius">
        <p><strong>Database list</strong></p>
        <div class="results-list" id="dbs">
        </div>        			
      </div>
    </div>
    
    <div class="large-4 columns">
      <div class="panel radius">
        <p><strong>Online Journals list</strong></p>
        <div class="results-list" id="sfx">
        </div>
      </div>
    </div>

    <div class="large-4 columns">
      <div class="panel radius">
        <p><strong>Books and Journals</strong></p>
        <div class="results-list" id="millennium">
        </div>
      </div>
    </div>
  </div>

  <div class="row results-row">
    <div class="large-4 columns">
      <div class="panel radius">
        <p><strong>PubMed</strong></p>
        <div class="results-list" id="pubmed">
        </div>       			
      </div>
    </div>

    <div class="large-4 columns">
      <div class="panel radius">
        <p><strong>Guides</strong></p>
        <div class="results-list" id="libguides">
        </div>       			
      </div>
    </div>

    <div class="large-4 columns">
      <div class="panel radius">
        <p><strong>Library Info</strong></p>
        <div class="results-list" id="drupal6">
        </div>
      </div>
    </div>
  </div>

  <!-- if IE8 or less, give up and redirect to legacy QuickSearch -->
  <!--[if lt IE 9]>
    <script>
      window.location = 'http://www.library.ucsf.edu/quicksearch/' + encodeURIComponent(decodeURIComponent(window.location.hash.substring(1)));
    </script>
  <![endif]-->

  <script src="js/vendor/jquery.js"></script>
  <script src="js/foundation.min.js"></script>
  
  <!-- If IE9 or less, fix their broken XHR/CORS implementation -->
  <!--[if IE]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-ajaxtransport-xdomainrequest/1.0.2/jquery.xdomainrequest.min.js"></script>
  <![endif]-->
  <script>
    $(document).foundation();
  </script>

  <script>
  $(document).ready(function () {
    var showSuggestedTerms = function (suggestedTerms) {
      if (suggestedTerms) {
        var termsLink = $('<a>')
          .attr('href', '#' + suggestedTerms);
        termsLink.append(
          $('<em>')
            .text(suggestedTerms)
        );

        var didyoumean = $('#didyoumean').show();
        var alertBox = $('<div>')
          .addClass('alert-box')
          .addClass('info');
        var span = $('<span>')
          .append('Did you mean ')
          .append(termsLink)
          .append('?');
        alertBox.append(span);
        didyoumean.append(alertBox);
      }
    };

    var success = function (results) {
      var urlRegExp = /^(https?:)?\/\/[\w:\/\?&%=\.\-~\+]+$/;
      var elem = $('#' + results.name);
      if (elem.length) {
        elem.empty();
        var ol = $('<ol>');
        var li;
        var a;
        var text;

        var l = results.data.length;
        if (l) {
          for (var i=0; i<l; i++) {
            if (typeof results.data[i].url === "string" && results.data[i].url.match(urlRegExp)) {
              li = $('<li>');
              a = $('<a>')
                .attr('href', results.data[i].url)
                .text(results.data[i].name);
              li.append(a);
              ol.append(li);
            } else {
              if (window.console && window.console.log) {
                window.console.log('Bad URL: ' + results.data[i].url);
              }
            } 
          }
          elem.append(ol);
          if (results.name !== "drupal6" && typeof results.url === "string" && results.url.match(urlRegExp)) {
            elem.append($('<a>').attr('href', results.url).text('All Results'));
          }
        } else {
          elem.text('No results found.');
        }
      }

      if (results.name === "pubmed" && results.suggestedTerms instanceof Array) {
        showSuggestedTerms(results.suggestedTerms[0]); 
      }
    }
    
    var failure = function (error) {
      if (console && error.message) {
        console.log(error.message);
      }
    };
    
    var runSearch = function (event) {
        $('#didyoumean').empty().hide();
        $('.results-list').each(function (index, elem) {
          elem.innerHTML = '<progress>Loading&hellip;</progress>';
        });
        var terms = this.querySelector('.search-terms').value;
        window.location.hash = encodeURIComponent(terms);
        if (typeof EventSource !== "undefined") {
          // asynchronous updates, woo hoo!
          UCSF.Library.search({q: terms, async: true}, success, failure);
        } else {
          // one big fat honkin' update (or else six separate AJAX calls), boo!
          $.getJSON( 'http://apis.ucsf.edu/library/search', {q: terms}, function (cols) {
            console.log(cols);
            for (var i=0, l=cols.length; i<l; i++) {
              success(cols[i]);
            }
          }).fail(failure);
        }
      };

    $('.search-form').each(function (index, elem) {
      elem.onsubmit = function (event) {
        event.preventDefault ? event.preventDefault() : event.returnValue = false;
        var terms = this.querySelector('.search-terms').value;
        window.location.hash = encodeURIComponent(terms);
      }
    });

    var runSearchWithHashValue = function () {
      document.querySelector('.search-terms').value = decodeURIComponent(window.location.hash.substring(1));
      runSearch.call(document, document);
    }

    if (window.location.hash) {
      $('title').text('UCSF Library Search: ' + decodeURIComponent(window.location.hash.substring(1)));
      runSearchWithHashValue()
    }

    var hashChangeHandler = function () {
      $('title').text('UCSF Library Search: ' + decodeURIComponent(window.location.hash.substring(1)));
      ga('send', 'pageview');
      runSearchWithHashValue();
    };

    $(window).bind('hashchange', hashChangeHandler);
  });
  </script>
